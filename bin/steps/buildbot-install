# Install dependencies with Pip.
puts-step "Installing buildbot dependencies"

if [ ! "$BB_BRANCH" ]; then
    BB_BRANCH = 'master'
fi

if [ ! "$BB_REPO" ]; then
    BB_BRANCH='https//github.com/buildbot/buildbot'
fi

if [ ! "$BB_WWW" ]; then
    BB_WWW='base'
fi

if [ -d "$CACHE_DIR/buildbot" ]; then
    cd "$CACHE_DIR/buildbot" 
    git fetch | cleanup | indent
    git checkout "origin/$BB_BRANCH" | cleanup | indent
    git checkout -B "$BB_BRANCH" | cleanup | indent
    cd -
    
    /app/.heroku/python/bin/pip uninstall 'buildbot-www' | cleanup | indent
    /app/.heroku/python/bin/pip install -e "$CACHE_DIR/buildbot/www/$BB_WWW" | cleanup | indent
else
    git clone -b "$BB_BRANCH" "$BB_REPO" "$CACHE_DIR/buildbot"

    /app/.heroku/python/bin/pip install mock | cleanup | indent
    /app/.heroku/python/bin/pip install -e "$CACHE_DIR/buildbot/master" | cleanup | indent
    /app/.heroku/python/bin/pip install -e "$CACHE_DIR/buildbot/pkg" | cleanup | indent
    /app/.heroku/python/bin/pip install -e "$CACHE_DIR/buildbot/www/$BB_WWW" | cleanup | indent
fi

cd "$BUILD_DIR"

/app/.heroku/python/bin/buildbot create-master master

if [ ! -f "$BUILD_DIR/master.cfg" ]; then
    cp "$ROOT_DIR/vendor/master.cfg.sample" "$BUILD_DIR/master.cfg"
fi
echo
